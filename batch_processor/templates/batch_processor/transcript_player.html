{% extends "batch_processor/base.html" %}
{% load static %}

{% block title %}Transcript Player{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'batch_processor/css/transcript_player.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
<!-- WaveSurfer.js for audio visualization - trying multiple CDNs for reliability -->
<script src="https://unpkg.com/wavesurfer.js@6.6.4/dist/wavesurfer.min.js"></script>
<script>
// More robust WaveSurfer loading with multiple fallbacks
document.addEventListener('DOMContentLoaded', function() {
  // Check if WaveSurfer loaded correctly
  if (typeof WaveSurfer === 'undefined') {
    console.error("ERROR: Primary WaveSurfer.js CDN failed! Trying alternative sources...");
    
    // Try loading from alternate CDN
    var script1 = document.createElement('script');
    script1.src = "https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.6.4/wavesurfer.min.js";
    script1.onload = function() {
      console.log("WaveSurfer loaded from CDNJS fallback");
      // Explicitly trigger initialization after fallback loads
      if (typeof window.initializeAudioPlayer === 'function') {
        setTimeout(function() {
          console.log("Re-initializing audio player after fallback load");
          window.initializeAudioPlayer();
        }, 500);
      }
    };
    
    // Add a second fallback if needed
    script1.onerror = function() {
      console.error("ERROR: CDNJS fallback also failed! Trying last resort...");
      var script2 = document.createElement('script');
      script2.src = "https://cdn.jsdelivr.net/npm/wavesurfer.js@6.6.4/dist/wavesurfer.min.js";
      script2.onload = function() {
        console.log("WaveSurfer loaded from NPM fallback");
        // Explicitly trigger initialization after fallback loads
        if (typeof window.initializeAudioPlayer === 'function') {
  setTimeout(function() {
            console.log("Re-initializing audio player after fallback load");
            window.initializeAudioPlayer();
          }, 500);
        }
      };
      document.head.appendChild(script2);
    };
    
    document.head.appendChild(script1);
  } else {
    console.log("WaveSurfer.js loaded successfully from primary source");
  }
});
</script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Transcript Player</h2>
                <div class="audio-info">
                    <span class="badge bg-primary">{{ audio_file.title }}</span>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#debugInfo">
                        <i class="bi bi-info-circle"></i>
                    </button>
                </div>
            </div>

            <!-- Debug Information Section (Collapsed by default) -->
            <div class="collapse mb-3" id="debugInfo">
                <div class="card">
                    <div class="card-header bg-light">Debug Information</div>
                    <div class="card-body small">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Audio File Information:</h6>
                                <ul class="list-unstyled">
                                    <li><strong>ID:</strong> {{ audio_file.id }}</li>
                                    <li><strong>Title:</strong> {{ audio_file.title }}</li>
                                    <li><strong>Path:</strong> {{ audio_file.audio_file.path }}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Transcript Information:</h6>
                                <ul class="list-unstyled">
                                    <li><strong>ID:</strong> {{ transcript.id }}</li>
                                    <li><strong>Format:</strong> {{ transcript.format }}</li>
                                    <li><strong>Processing Status:</strong> {{ transcript.processing_status }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Audio Visualization and Controls Section -->
                <div class="col-md-12 mb-3">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Audio Visualization</span>
                            <div id="diarizationControlsContainer">
                                <!-- Diarization controls added dynamically -->
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Waveform visualization -->
                            <div id="waveform" class="mb-3"></div>
                            
                            <!-- Speaker visualization -->
                            <div id="speakerTimeline" class="mb-3"></div>
                            
                            <!-- Main playback controls -->
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <button id="playPauseBtn" class="btn btn-primary me-2">
                                        <i class="bi bi-play-fill"></i>
                                    </button>
                                    <div id="currentTime" class="time-display me-2">00:00</div>
                                    <span class="me-2">/</span>
                                    <div id="totalTime" class="time-display">00:00</div>
                                </div>
                                
                                <div class="audio-controls">
                                    <!-- Skip controls -->
                                    <div class="btn-group me-2">
                                        <button id="skip-back-10" class="btn btn-outline-secondary">
                                            <i class="bi bi-skip-backward"></i> 10s
                                        </button>
                                        <button id="skip-back-5" class="btn btn-outline-secondary">
                                            <i class="bi bi-skip-backward"></i> 5s
                                        </button>
                                        <button id="skip-forward-5" class="btn btn-outline-secondary">
                                            <i class="bi bi-skip-forward"></i> 5s
                                        </button>
                                        <button id="skip-forward-10" class="btn btn-outline-secondary">
                                            <i class="bi bi-skip-forward"></i> 10s
                                        </button>
                                    </div>
                                    
                                    <!-- Playback rate controls -->
                                    <div class="btn-group">
                                        <button id="rate-75" class="btn btn-outline-secondary">0.75x</button>
                                        <button id="rate-100" class="btn btn-outline-secondary active">1.0x</button>
                                        <button id="rate-125" class="btn btn-outline-secondary">1.25x</button>
                                        <button id="rate-150" class="btn btn-outline-secondary">1.5x</button>
                                        <button id="rate-200" class="btn btn-outline-secondary">2.0x</button>
                                    </div>
                                </div>
                                
                                <div class="zoom-controls">
                                    <button id="zoomIn" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-zoom-in"></i>
                                    </button>
                                    <button id="zoomOut" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-zoom-out"></i>
                                    </button>
                                    <button id="resetZoom" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-arrows-fullscreen"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- HTML5 audio element -->
                            <div class="audio-container">
                                <div id="simple-audio-player" class="mb-3">
                                    <audio id="audioPlayer" {% if audio_url %}src="{{ audio_url }}"{% endif %} controls>
                                        {% if audio_url %}<source src="{{ audio_url }}" type="audio/mpeg">{% endif %}
                                        Your browser does not support the audio element.
                                    </audio>
                                    
                                    {% if audio_url %}
                                    <div class="text-center mt-2 small">
                                        <span class="text-muted">Using audio URL:</span> 
                                        <code class="small">{{ audio_url }}</code>
                                    </div>
                                    <div class="text-center mt-1">
                                        <button id="refreshAudioBtn" class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-arrow-repeat"></i> Refresh Audio
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                {% if not audio_url %}
                                <div class="alert alert-warning mt-2">
                                    <strong>Warning:</strong> No audio URL provided. Audio playback will not work.
                                </div>
                                {% else %}
                                <div class="direct-audio-link mt-2">
                                    <div class="btn-group">
                                        <a href="{{ audio_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-file-earmark-music"></i> Standard Audio Link
                                        </a>
                                        <a href="{{ audio_url }}?direct=1" target="_blank" class="btn btn-sm btn-primary">
                                            <i class="bi bi-file-earmark-play"></i> Direct Audio Player
                                        </a>
                                    </div>
                                    <span class="badge bg-light text-dark ms-2">{{ audio_file.title }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Transcript and Speaker Mapping Section -->
                <div class="col-md-8">
                    <div class="card mb-3">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" id="formatTabs">
                                <li class="nav-item">
                                    <a class="nav-link active" id="chat-tab" data-bs-toggle="tab" href="#chat">CHAT Format</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="raw-tab" data-bs-toggle="tab" href="#raw">Raw Content</a>
                                </li>
                                <li class="nav-item ms-auto">
                                    <div class="form-check form-switch mt-1 d-flex align-items-center" 
                                         data-bs-toggle="tooltip" data-bs-placement="bottom" 
                                         title="When enabled, transcript will automatically scroll to follow the current playback position">
                                        <input class="form-check-input" type="checkbox" id="autoScrollToggle" checked>
                                        <label class="form-check-label small ms-1" for="autoScrollToggle">
                                            <i class="bi bi-arrow-down-circle me-1"></i>Follow playback
                                        </label>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="chat">
                                    <div id="chatHeader" class="transcript-header"></div>
                                    <div id="transcriptContainer" class="transcript-container">
                                        <!-- Transcript content will be loaded here -->
                                        <div class="text-center p-3">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Loading transcript...</span>
                                            </div>
                                            <span class="ms-2">Loading transcript...</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="raw">
                                    <pre id="rawContentDisplay" class="raw-content">{{ raw_content }}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card mb-3">
                        <div class="card-header">Speaker Mapping</div>
                        <div class="card-body">
                            <form id="speakerMappingForm">
                                <div id="speakerInputs" class="mb-3">
                                    <!-- Speaker inputs will be added here dynamically -->
                                    <div class="text-center p-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Loading speakers...</span>
                                        </div>
                                        <span class="ms-2">Loading speakers...</span>
                                    </div>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">Update Speaker Mapping</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Diarization Segments</span>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-download"></i> Export
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" id="copyDiarizationBtn">Copy to Clipboard</a></li>
                                    <li><a class="dropdown-item" href="#" id="downloadJsonBtn">Download JSON</a></li>
                                    <li><a class="dropdown-item" href="#" id="downloadCsvBtn">Download CSV</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" id="viewSegmentsBtn" data-bs-toggle="collapse" data-bs-target="#segmentDetails">View Segment Details</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="collapse" id="segmentDetails">
                            <div class="card-body">
                                <div class="segment-list small" id="segmentList">
                                    <!-- Segment details will be shown here -->
                                    <div class="text-center p-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Loading segments...</span>
                                        </div>
                                        <span class="ms-2">Loading segments...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Self-Test Results</span>
                                <button class="btn btn-sm btn-outline-secondary" id="showDebugBtn">
                                    Debug Info
                                </button>
                            </div>
                        <div class="card-body">
                            <div id="testResults">
                                <button id="runTestsBtn" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-check2-circle"></i> Run Self-Tests
                                </button>
                            </div>
                            
                            <div id="debugInfo" class="mt-3" style="display: none;">
                                <h6>Debug Information</h6>
                                <div class="debug-content small"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden data fields -->
<input type="hidden" id="transcriptId" value="{{ transcript.id }}">
<input type="hidden" id="chatContent" value="{{ chat_content|escapejs }}">
<input type="hidden" id="rawContent" value="{{ raw_content|escapejs }}">
<input type="hidden" id="diarizationData" value="{{ diarization_data|default:"[]" }}">
<input type="hidden" id="speakersData" value="{{ speaker_mappings|default:"{}" }}">
<input type="hidden" id="speakersJson" value="{{ speakers_json|default:"[]" }}">
<input type="hidden" id="missingSegmentsData" value="{{ missing_segments|default:"[]" }}">
<input type="hidden" id="pyannoteProcessed" value="{{ transcript.pyannote_processed|yesno:"True,False" }}">

{% endblock %}

{% block extra_js %}
<!-- Load modular JavaScript files -->
<script src="{% static 'batch_processor/js/transcript_player/unicode_decoder.js' %}"></script>
<script src="{% static 'batch_processor/js/transcript_player/audio_player.js' %}"></script>
<script src="{% static 'batch_processor/js/transcript_player/transcript_display.js' %}"></script>
<script src="{% static 'batch_processor/js/transcript_player/display_fix_helper.js' %}"></script>
<script src="{% static 'batch_processor/js/transcript_player/transcript_enhancer.js' %}"></script>
<script src="{% static 'batch_processor/js/transcript_player/autoscroll_fix.js' %}"></script>
<script src="{% static 'batch_processor/js/transcript_player/speaker_mapping.js' %}"></script>
<script src="{% static 'batch_processor/js/transcript_player/speaker_timeline.js' %}"></script>
<script src="{% static 'batch_processor/js/transcript_player/missing_segments.js' %}"></script>

<!-- Common functionality and initialization -->
<script>
// Global variables and utility functions
window.autoScroll = true;
window.colorPalette = [
    '#4285F4', '#EA4335', '#FBBC05', '#34A853', // Google colors
    '#8E44AD', '#3498DB', '#1ABC9C', '#F39C12', // Material colors
    '#7F8C8D', '#9B59B6', '#2ECC71', '#E74C3C'  // More vibrant options
];

// Format time in MM:SS - backup function
window.formatTime = function(seconds) {
    if (isNaN(seconds)) return "00:00";
    const minutes = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
};

// Refresh audio button functionality
document.getElementById('refreshAudioBtn')?.addEventListener('click', function() {
    const audioPlayer = document.getElementById('audioPlayer');
    if (audioPlayer) {
        const currentSrc = audioPlayer.src;
        audioPlayer.src = '';
        audioPlayer.src = currentSrc + (currentSrc.includes('?') ? '&' : '?') + 'refresh=' + Date.now();
        audioPlayer.load();
        this.innerHTML = '<i class="bi bi-check"></i> Audio Refreshed';
        setTimeout(() => {
            this.innerHTML = '<i class="bi bi-arrow-repeat"></i> Refresh Audio';
        }, 3000);
    }
});

// Debug button functionality
document.getElementById('showDebugBtn')?.addEventListener('click', function() {
    const debugInfo = document.getElementById('debugInfo');
    if (debugInfo) {
        debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        
        if (debugInfo.style.display === 'block') {
            const debugContent = document.querySelector('.debug-content');
            if (debugContent) {
                let html = '<ul class="list-unstyled">';
                html += `<li><strong>WaveSurfer ready:</strong> ${window.wavesurfer ? window.wavesurfer.isReady : 'Not initialized'}</li>`;
                html += `<li><strong>Auto-scroll:</strong> ${window.autoScroll}</li>`;
                html += `<li><strong>Audio element:</strong> ${document.getElementById('audioPlayer') ? 'Found' : 'Not found'}</li>`;
                html += `<li><strong>Audio URL:</strong> ${document.getElementById('audioPlayer')?.src || 'None'}</li>`;
                html += `<li><strong>Transcript ID:</strong> ${document.getElementById('transcriptId')?.value || 'None'}</li>`;
                html += `<li><strong>Chat content length:</strong> ${document.getElementById('chatContent')?.value.length || 0} chars</li>`;
                html += '</ul>';
                debugContent.innerHTML = html;
            }
        }
    }
});

// Self-test functionality
document.getElementById('runTestsBtn')?.addEventListener('click', function() {
    const testResults = document.getElementById('testResults');
    if (!testResults) return;
    
    testResults.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Running tests...';
    
    // Perform tests
    setTimeout(() => {
        const tests = [
            { name: "WaveSurfer loaded", passed: typeof WaveSurfer !== 'undefined' },
            { name: "WaveSurfer initialized", passed: window.wavesurfer && window.wavesurfer.isReady },
            { name: "Audio player exists", passed: !!document.getElementById('audioPlayer') },
            { name: "Transcript container exists", passed: !!document.getElementById('transcriptContainer') },
            { name: "Chat content loaded", passed: document.getElementById('chatContent')?.value.length > 0 },
            { name: "Audio URL available", passed: document.getElementById('audioPlayer')?.src && document.getElementById('audioPlayer').src.length > 0 }
        ];
        
        // Count passed tests
        const passedCount = tests.filter(t => t.passed).length;
        
        // Generate HTML report
        let html = `<h6>Test Results: ${passedCount}/${tests.length} passed</h6>`;
        html += '<ul class="list-group">';
        
        tests.forEach(test => {
            const statusClass = test.passed ? 'bg-success' : 'bg-danger';
            const icon = test.passed ? 'check-circle-fill' : 'x-circle-fill';
            
            html += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>${test.name}</span>
                    <span class="badge ${statusClass}"><i class="bi bi-${icon}"></i></span>
                </li>
            `;
        });
        
        html += '</ul>';
        html += `
            <div class="mt-3">
                <button id="fixIssuesBtn" class="btn btn-sm btn-outline-warning">
                    <i class="bi bi-tools"></i> Fix Common Issues
                </button>
                <button id="runTestsBtn" class="btn btn-sm btn-outline-primary ms-2">
                    <i class="bi bi-check2-circle"></i> Run Again
                </button>
            </div>
        `;
        
        testResults.innerHTML = html;
        
        // Add fix issues button handler
        document.getElementById('fixIssuesBtn')?.addEventListener('click', function() {
            // Reload wavesurfer if needed
            if (!window.wavesurfer || !window.wavesurfer.isReady) {
                console.log("Attempting to fix WaveSurfer...");
                
                // Try to reinitialize WaveSurfer
                if (typeof window.initializeAudioPlayer === 'function') {
                    window.initializeAudioPlayer();
                }
            }
            
            // Reload transcript display if needed
            if (document.getElementById('transcriptContainer').childElementCount === 0) {
                console.log("Attempting to fix transcript display...");
                
                if (typeof window.initializeTranscriptDisplay === 'function') {
                    window.initializeTranscriptDisplay();
                }
            }
            
            // Reload the page as a last resort if nothing else works
            if (!window.wavesurfer || !window.wavesurfer.isReady) {
                if (confirm("Unable to fix issues automatically. Reload the page?")) {
                    window.location.reload();
                }
            }
        });
    }, 500);
});

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM fully loaded - initializing transcript player");
    
    // Initialize Bootstrap tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    
    // Setup auto-scroll toggle with enhanced feedback
    const autoScrollToggle = document.getElementById('autoScrollToggle');
    if (autoScrollToggle) {
        window.autoScroll = autoScrollToggle.checked;
        
        autoScrollToggle.addEventListener('change', function() {
            window.autoScroll = this.checked;
            console.log("Auto-scroll set to:", window.autoScroll);
            
            // Add visual feedback for the toggle state
            const label = autoScrollToggle.nextElementSibling;
            if (label) {
                if (this.checked) {
                    label.innerHTML = '<i class="bi bi-arrow-down-circle-fill me-1"></i>Following playback';
                } else {
                    label.innerHTML = '<i class="bi bi-arrow-down-circle me-1"></i>Follow playback';
                }
            }
            
            // If turning on auto-scroll, immediately scroll to current position
            if (this.checked) {
                const activeElement = document.querySelector('.transcript-line.active');
                if (activeElement) {
                    scrollToElement(activeElement);
                }
            }
        });
    }
    
    // Initialize modular JS components
    if (typeof window.initializeAudioPlayer === 'function') {
        console.log("Initializing audio player...");
        window.initializeAudioPlayer();
    } else {
        console.error("Audio player initialization function not found");
    }
    
    if (typeof window.initializeTranscriptDisplay === 'function') {
        console.log("Initializing transcript display...");
        window.initializeTranscriptDisplay();
        } else {
        console.error("Transcript display initialization function not found");
    }
    
        if (typeof window.initializeSpeakerMappings === 'function') {
        console.log("Initializing speaker mappings...");
                window.initializeSpeakerMappings();
    } else {
        console.error("Speaker mapping initialization function not found");
    }
    
    if (typeof window.initializeMissingSegments === 'function') {
        console.log("Initializing missing segments...");
        window.initializeMissingSegments();
    }
    
    // Create a centralized updateTranscriptHighlight function that other modules can call
    window.updateTranscriptTime = function(currentTimeMs) {
        if (!currentTimeMs && window.wavesurfer && window.wavesurfer.isReady) {
            currentTimeMs = window.wavesurfer.getCurrentTime() * 1000;
        } else if (!currentTimeMs && window.player) {
            currentTimeMs = window.player.currentTime * 1000;
        }
        
        if (typeof window.highlightTranscriptAtTime === 'function') {
            window.highlightTranscriptAtTime(currentTimeMs);
        }
    };
    
    // Set a timeout to check if everything loaded correctly
    setTimeout(function() {
        // Check if WaveSurfer is initialized
        if (!window.wavesurfer || !window.wavesurfer.isReady) {
            console.warn("WaveSurfer not properly initialized after timeout - showing run tests button");
            document.getElementById('runTestsBtn').classList.add('btn-warning');
            document.getElementById('runTestsBtn').classList.remove('btn-outline-primary');
            document.getElementById('runTestsBtn').innerHTML = '<i class="bi bi-exclamation-triangle"></i> Run Diagnostics';
        }
        
        // Check if transcript is displayed
        if (document.getElementById('transcriptContainer').childElementCount === 0) {
            console.warn("Transcript container empty after timeout");
            document.getElementById('transcriptContainer').innerHTML = `
            <div class="alert alert-warning">
                    <strong>Warning:</strong> Transcript failed to load. 
                    <button id="reloadTranscriptBtn" class="btn btn-sm btn-warning">Reload Transcript</button>
            </div>
        `;
            
            document.getElementById('reloadTranscriptBtn')?.addEventListener('click', function() {
                if (typeof window.initializeTranscriptDisplay === 'function') {
                    window.initializeTranscriptDisplay();
        }
    });
}
    }, 5000);
});
</script>
{% endblock %}