{% extends "batch_processor/base.html" %}
{% load static %}

{% block title %}Transcript Player{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'batch_processor/css/transcript_player.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h1>Transcript Player</h1>
            <p>Audio file: {{ audio_file.title }}</p>
            
            <!-- Debug Information Section -->
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#debugInfo">
                        Toggle Debug Info
                    </button>
                    Debug Information
                </div>
                <div class="collapse" id="debugInfo">
                    <div class="card-body">
                        <h5>Audio File Information:</h5>
                        <ul>
                            <li>ID: {{ audio_file.id }}</li>
                            <li>Title: {{ audio_file.title }}</li>
                            <li>Path: {{ audio_file.audio_file.path }}</li>
                            <li>URL: {{ audio_file.audio_file.url }}</li>
                        </ul>
                        
                        <h5>Transcript Information:</h5>
                        <ul>
                            <li>ID: {{ transcript.id }}</li>
                            <li>Format: {{ transcript.format }}</li>
                            <li>Processing Status: {{ transcript.processing_status }}</li>
                        </ul>
                        
                        <h5>Audio URL:</h5>
                        <p>{{ audio_url }}</p>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" id="formatTabs">
                                <li class="nav-item">
                                    <a class="nav-link active" id="chat-tab" data-bs-toggle="tab" href="#chat">CHAT Format</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="raw-tab" data-bs-toggle="tab" href="#raw">Raw Content</a>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="chat">
                                    <div id="chatHeader" class="transcript-header"></div>
                                    <div id="transcriptContainer" class="transcript-container"></div>
                                </div>
                                <div class="tab-pane fade" id="raw">
                                    <pre id="rawContent" class="raw-content">{{ transcript.raw_content }}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Audio Player</div>
                        <div class="card-body">
                            <div id="audioPlayerContainer">
                                <audio id="audioPlayer" controls>
                                    <source src="{{ audio_url }}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                                
                                <div class="playback-controls mt-3">
                                    <div class="btn-group mb-2" role="group">
                                        <button id="skip-back-10" class="btn btn-outline-secondary" onclick="skipBackward(10)">
                                            <i class="bi bi-skip-backward"></i> 10s
                                        </button>
                                        <button id="skip-back-5" class="btn btn-outline-secondary" onclick="skipBackward(5)">
                                            <i class="bi bi-skip-backward"></i> 5s
                                        </button>
                                        <button id="skip-forward-5" class="btn btn-outline-secondary" onclick="skipForward(5)">
                                            <i class="bi bi-skip-forward"></i> 5s
                                        </button>
                                        <button id="skip-forward-10" class="btn btn-outline-secondary" onclick="skipForward(10)">
                                            <i class="bi bi-skip-forward"></i> 10s
                                        </button>
                                    </div>
                                    
                                    <div class="btn-group" role="group">
                                        <button id="rate-75" class="btn btn-outline-secondary" onclick="adjustPlaybackRate(0.75)">0.75x</button>
                                        <button id="rate-100" class="btn btn-outline-secondary active" onclick="adjustPlaybackRate(1.0)">1.0x</button>
                                        <button id="rate-125" class="btn btn-outline-secondary" onclick="adjustPlaybackRate(1.25)">1.25x</button>
                                        <button id="rate-150" class="btn btn-outline-secondary" onclick="adjustPlaybackRate(1.5)">1.5x</button>
                                        <button id="rate-200" class="btn btn-outline-secondary" onclick="adjustPlaybackRate(2.0)">2.0x</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-3">
                        <div class="card-header">Speaker Mapping</div>
                        <div class="card-body">
                            <form id="speakerMappingForm">
                                <div id="speakerInputs">
                                    <!-- Speaker inputs will be added here dynamically -->
                                </div>
                                <button type="submit" class="btn btn-primary">Update Speaker Mapping</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="transcriptId" value="{{ transcript.id }}">
<input type="hidden" id="chatContent" value="{{ transcript.chat_content|escapejs }}">
<input type="hidden" id="rawContent" value="{{ transcript.raw_content|escapejs }}">
<input type="hidden" id="diarizationData" value="{{ transcript.diarization_data|escapejs }}">
<input type="hidden" id="speakersData" value="{{ speaker_mappings|escapejs }}">
<input type="hidden" id="missingSegmentsData" value="{{ transcript.missing_segments|escapejs }}">
<input type="hidden" id="pyannoteProcessed" value="{{ transcript.pyannote_processed }}">

{% endblock %}

{% block extra_js %}
<script>
// Initialize global variables
const player = document.getElementById('audioPlayer');
const uniqueSpeakers = new Set();
const speakerMappings = {};
const speakerColors = {};
let currentPlaybackRate = 1.0;

// Color palette for speakers
const colorPalette = [
    '#007bff', '#6610f2', '#6f42c1', '#e83e8c', '#dc3545',
    '#fd7e14', '#ffc107', '#28a745', '#20c997', '#17a2b8'
];

// Pass data to JavaScript
const speakersJson = '{{ speakers_json|escapejs }}';
const missingSegmentsJson = '{{ missing_segments|escapejs|safe }}';

// Function to run Pyannote diarization
function runPyannoteDiarization(transcriptId) {
    // Show loading indicator
    const runButton = document.getElementById('runPyannoteBtn');
    if (runButton) {
        runButton.disabled = true;
        runButton.innerHTML = '<i class="bi bi-arrow-repeat spinning"></i> Running Diarization...';
    }
    
    // Show processing message
    const messageDiv = document.createElement('div');
    messageDiv.className = 'alert alert-info';
    messageDiv.id = 'processingMessage';
    messageDiv.innerHTML = `
        <strong>Processing Audio...</strong> 
        <p>Analyzing speakers with Pyannote. This may take a few minutes depending on audio length.</p>
        <p>You'll need a valid Hugging Face token with access to the Pyannote model.</p>
    `;
    document.querySelector('.container').prepend(messageDiv);
    
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Call the server to run Pyannote
    fetch(`/transcript/${transcriptId}/run-pyannote/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log("Pyannote processing complete:", data);
        
        // Remove processing message
        const processingMessage = document.getElementById('processingMessage');
        if (processingMessage) {
            processingMessage.remove();
        }
        
        if (data.success) {
            // Show success message
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success';
            successAlert.innerHTML = `
                <strong>Success!</strong> Speaker diarization completed.
                <p>Found ${data.diarization_count || 0} segments and identified ${data.missing_segments_count || 0} missing segments.</p>
                <p>Reloading page to show results...</p>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.container').prepend(successAlert);
            
            // Reload the page to show the new results
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } else {
            // Show detailed error message
            const errorAlert = document.createElement('div');
            errorAlert.className = 'alert alert-danger';
            
            let errorMessage = data.message || 'An error occurred during diarization';
            let helpText = '';
            
            // Check for specific errors
            if (errorMessage.includes('authenticate') || errorMessage.includes('token') || 
                errorMessage.includes('Hugging Face')) {
                helpText = `
                    <div class="mt-3">
                        <h5>How to fix this:</h5>
                        <ol>
                            <li>Go to <a href="https://huggingface.co/settings/tokens" target="_blank">Hugging Face Tokens</a> to create a token</li>
                            <li>Visit <a href="https://huggingface.co/pyannote/speaker-diarization-3.1" target="_blank">pyannote/speaker-diarization-3.1</a> and accept the user agreement</li>
                            <li>Go to <a href="/settings/">Settings</a> and enter your token</li>
                        </ol>
                    </div>
                `;
            }
            
            errorAlert.innerHTML = `
                <strong>Error:</strong> ${errorMessage}
                ${helpText}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.container').prepend(errorAlert);
            
            // Reset button
            if (runButton) {
                runButton.disabled = false;
                runButton.innerHTML = 'Run Speaker Diarization';
            }
        }
    })
    .catch(error => {
        console.error("Error running Pyannote:", error);
        
        // Remove processing message
        const processingMessage = document.getElementById('processingMessage');
        if (processingMessage) {
            processingMessage.remove();
        }
        
        // Show error message
        const errorAlert = document.createElement('div');
        errorAlert.className = 'alert alert-danger';
        errorAlert.innerHTML = `
            <strong>Error:</strong> Failed to run speaker diarization. ${error.message}
            <div class="mt-2">
                <p>This may be due to:</p>
                <ul>
                    <li>Missing or invalid Hugging Face token</li>
                    <li>Not accepting the model license</li>
                    <li>Server error processing the audio</li>
                </ul>
                <p>Check the browser console for more details.</p>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector('.container').prepend(errorAlert);
        
        // Reset button
        if (runButton) {
            runButton.disabled = false;
            runButton.innerHTML = 'Run Speaker Diarization';
        }
    });
}
</script>

<!-- Load modular JavaScript files -->
<script src="{% static 'batch_processor/js/transcript_player/audio_player.js' %}"></script>
<script src="{% static 'batch_processor/js/transcript_player/transcript_display.js' %}"></script>
<script src="{% static 'batch_processor/js/transcript_player/speaker_mapping.js' %}"></script>
<script src="{% static 'batch_processor/js/transcript_player/missing_segments.js' %}"></script>

<script>
// Simplified initialization with a direct approach for better browser compatibility
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM loaded, initializing transcript player");
    
    // Helper functions used in multiple places
    window.formatTime = function(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    };
    
    window.seekToTime = function(milliseconds) {
        if (window.player) {
            window.player.currentTime = milliseconds / 1000;
            if (window.player.paused) {
                try {
                    window.player.play();
                } catch (e) {
                    console.error("Error playing audio:", e);
                }
            }
        }
    };
    
    // Define player variable in global scope
    window.player = document.getElementById('audioPlayer');
    
    // Check if audio player exists
    if (!window.player) {
        console.error("Audio player element not found");
        document.getElementById('audioPlayerContainer').innerHTML = `
            <div class="alert alert-danger">
                <strong>Error:</strong> Audio player could not be initialized.
                The audio file may be missing or inaccessible.
            </div>
        `;
        return;
    }
    
    // Initialization order is important:
    // 1. First initialize audio player
    try {
        window.initializeAudioPlayer();
    } catch (e) {
        console.error("Error initializing audio player:", e);
    }
    
    // 2. Initialize transcript display
    try {
        window.initializeTranscriptDisplay();
    } catch (e) {
        console.error("Error initializing transcript display:", e);
    }
    
    // 3. Initialize speaker mappings
    try {
        if (typeof window.initializeSpeakerMappings === 'function') {
            window.initializeSpeakerMappings();
        }
        if (typeof window.assignSpeakerColors === 'function') {
            window.assignSpeakerColors();
        }
    } catch (e) {
        console.error("Error initializing speaker mappings:", e);
    }
    
    // 4. Initialize missing segments handling
    try {
        if (typeof window.initializeMissingSegments === 'function') {
            window.initializeMissingSegments();
        }
    } catch (e) {
        console.error("Error initializing missing segments:", e);
    }
    
    // Check if Pyannote has been run
    const pyannoteProcessed = document.getElementById('pyannoteProcessed').value === 'True';
    if (!pyannoteProcessed) {
        // Show button to run Pyannote diarization
        const transcriptId = document.getElementById('transcriptId').value;
        
        // Find the Audio Player card header
        let audioPlayerContainer = null;
        const headers = document.querySelectorAll('.card-header');
        for (const header of headers) {
            if (header.textContent.includes('Audio Player')) {
                audioPlayerContainer = header;
                break;
            }
        }
        
        if (audioPlayerContainer) {
            console.log("Found audio player container:", audioPlayerContainer);
            const runPyannoteBtn = document.createElement('button');
            runPyannoteBtn.id = 'runPyannoteBtn';
            runPyannoteBtn.className = 'btn btn-sm btn-outline-primary float-end';
            runPyannoteBtn.innerHTML = 'Run Speaker Diarization';
            runPyannoteBtn.addEventListener('click', function() {
                runPyannoteDiarization(transcriptId);
            });
            
            // Check if button already exists before adding
            if (!audioPlayerContainer.querySelector('#runPyannoteBtn')) {
                audioPlayerContainer.appendChild(runPyannoteBtn);
                console.log("Added run pyannote button");
            }
        } else {
            console.error("Could not find audio player container");
        }
    }
    
    console.log("Transcript player initialization complete");
});
</script>
{% endblock %} 